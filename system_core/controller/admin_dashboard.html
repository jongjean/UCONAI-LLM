<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCONAI 2.0 DASHBPARD</title>
    <style>
        :root {
            --bg: #03060a;
            --panel: rgba(13, 17, 23, 0.9);
            --border: #30363d;
            --text: #e6edf3;
            --muted: #8b949e;
            --accent: #1f6feb;
            --success: #3fb950;
            --warning: #d29922;
            --error: #f85149;
            --glow: rgba(31, 111, 235, 0.3);
        }

        body {
            background: radial-gradient(circle at 50% 50%, #0d1117 0%, #03060a 100%);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #left-pane {
            width: 70%;
            min-width: 400px;
            display: flex;
            flex-direction: column;
            padding: 12px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }

        #right-pane {
            flex: 1;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            background: var(--bg);
        }

        .resizer-v {
            width: 6px;
            cursor: col-resize;
            background: transparent;
            z-index: 100;
            transition: 0.2s;
        }

        .resizer-v:hover,
        .resizer-v.dragging {
            background: var(--accent);
            box-shadow: 0 0 10px var(--glow);
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .grid-row {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-bottom: 12px;
        }

        .monitor-item {
            flex: 1;
            min-width: 200px;
            height: 350px;
            display: flex;
            flex-direction: column;
        }

        .stat-val {
            font-size: 2.2em;
            font-weight: 800;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
        }

        h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        pre {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.95em;
            overflow: auto;
            margin: 0;
            flex: 1;
            line-height: 1.3;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 10px;
            border-radius: 10px;
            max-width: 85%;
            font-size: 0.95em;
            line-height: 1.4;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .message.ai {
            background: #1c2733;
            align-self: flex-start;
            border: 1px solid #2a3a4a;
        }

        .message.user {
            background: #1e3a22;
            align-self: flex-end;
            border: 1px solid #2a4a30;
            color: #afffbc;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
        }

        textarea {
            width: 100%;
            height: 80px;
            background: #0d1117;
            border: 1px solid var(--border);
            color: white;
            border-radius: 8px;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
        }

        .health-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
            background: rgba(63, 185, 80, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .tabs {
            display: flex;
            gap: 8px;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 6px;
            color: var(--muted);
            font-weight: 600;
        }

        .tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 10px var(--glow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .security-btn {
            background: rgba(31, 111, 235, 0.05);
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            transition: 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .security-btn:hover {
            background: rgba(31, 111, 235, 0.15);
            color: #fff;
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--glow);
        }

        .security-btn strong {
            color: var(--accent);
        }

        .status-led {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 5px var(--success);
        }
    </style>
</head>

<body>
    <div class="container" id="main-container">
        <div id="left-pane">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                <div class="tabs">
                    <div class="tab" id="tab-btn-1p" onclick="showTab('1p')">1P Í¥ÄÏ†ú</div>
                    <div class="tab" id="tab-btn-2p" onclick="showTab('2p')">2P Linux</div>
                    <div class="tab" id="tab-btn-3p" onclick="showTab('3p')">3P ÏûêÎèôÌôî</div>
                    <div class="tab" id="tab-btn-4p" onclick="showTab('4p')">4P AIÍ¥ÄÎ¶¨</div>
                </div>
                <h2 style="margin:0; font-size: 1.4em; color: var(--accent); text-shadow: 0 0 10px var(--glow);">UCONAI
                    2.0 DASHBPARD</h2>
            </div>
            <div id="1p" class="tab-content">
                <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                    <div class="health-badge">‚óè NEURAL_LINK LIVE</div>
                </div>
                <div class="card" style="border-bottom: 2px solid var(--accent);">
                    <h3>üì° SYSTEM VITALS</h3>
                    <div style="display:flex; justify-content:space-around; text-align:center;">
                        <div style="width:20%;">
                            <div id="cpu-ring" class="stat-val" style="color:var(--accent);">--%</div>
                            <div class="stat-label">CPU LOAD</div>
                        </div>
                        <div style="width:20%;">
                            <div id="ram-ring" class="stat-val" style="color:var(--success);">--%</div>
                            <div class="stat-label">RAM USAGE</div>
                        </div>
                        <div style="width:20%;">
                            <div id="gpu-util" class="stat-val" style="color:var(--warning);">--%</div>
                            <div class="stat-label">GPU LOAD</div>
                        </div>
                        <div style="width:25%; border-left: 1px solid #333; padding-left: 15px; text-align: left;">
                            <div id="vm-uptime" class="stat-val" style="font-size: 1.8em;">--s</div>
                            <div class="stat-label">UPTIME</div>
                            <div id="vm-vga"
                                style="font-size:0.75em; color:var(--muted); margin-top:5px; font-weight: bold;">VGA:
                                Scanning...</div>
                            <div id="gpu-temp" style="font-size:0.75em; color:var(--error); font-weight: bold;">TEMP:
                                --¬∞C</div>
                        </div>
                    </div>
                </div>
                <div class="grid-row">
                    <div class="monitor-item card">
                        <h3>üî• PROCESS TOP 20</h3>
                        <div id="process-list"
                            style="overflow-y:auto; flex:1; font-family:monospace; font-size:0.85em; background:rgba(0,0,0,0.2); border-radius:4px; padding:5px;">
                            Initializing...</div>
                    </div>
                    <div class="monitor-item card">
                        <h3>üåê PORT MONITOR</h3>
                        <pre id="port-list" style="overflow-y:auto; flex:1;">Scanning ports...</pre>
                    </div>
                    <div class="monitor-item card">
                        <h3>üíæ STORAGE MAP</h3>
                        <pre id="storage-list" style="overflow-y:auto; flex:1;">Checking drives...</pre>
                    </div>
                </div>
                <div class="card" style="border-color: var(--error); background: rgba(248,81,73,0.05);">
                    <h3 style="color:var(--error);">üö® BLACK BOX: SYSTEM ANOMALIES</h3>
                    <div id="fault-list" style="font-family:monospace; font-size:0.9em;">Neural integrity verified. 0
                        Failures.</div>
                </div>
            </div>
            <div id="2p" class="tab-content">
                <style>
                    .linux-grid {
                        display: grid;
                        gap: 10px;
                        grid-template-columns: 1fr 1fr 1fr;
                        height: calc(100% - 100px);
                    }

                    .linux-card {
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 6px;
                        padding: 10px;
                        display: flex;
                        flex-direction: column;
                    }

                    .stat-gauge-row {
                        display: flex;
                        justify-content: space-around;
                        margin-bottom: 5px;
                    }

                    .stat-gauge {
                        text-align: center;
                        background: #000;
                        border-radius: 8px;
                        padding: 8px;
                        width: 30%;
                    }

                    .stat-gauge h4 {
                        margin: 0;
                        font-size: 0.8em;
                        color: var(--muted);
                    }

                    .stat-gauge .val {
                        font-size: 1.5em;
                        font-weight: bold;
                    }

                    .prj-grid {
                        display: grid;
                        gap: 5px;
                        grid-template-columns: repeat(2, 1fr);
                        overflow-y: auto;
                        flex: 1;
                    }

                    .prj-item {
                        background: #222;
                        padding: 5px 8px;
                        border-radius: 4px;
                        font-size: 0.8em;
                        color: var(--text);
                        border-left: 3px solid var(--accent);
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                </style>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; color:var(--warning);">üêß LINUX CONTROL TOWER</h3>
                    <div class="health-badge"
                        style="color:var(--success); border-color:var(--success); background:rgba(46,160,67,0.1);">‚óè
                        CONNECTED</div>
                </div>

                <!-- Row 1: Top Metrics (CPU, GPU, RAM) -->
                <div class="stat-gauge-row">
                    <div class="stat-gauge">
                        <h4>CPU USAGE</h4>
                        <div id="lx-cpu-val" class="val" style="color:var(--accent);">0%</div>
                    </div>
                    <div class="stat-gauge">
                        <h4>GPU UTIL</h4>
                        <div id="lx-gpu-val" class="val" style="color:var(--warning);">0%</div>
                        <div id="lx-gpu-mem" style="font-size:0.75em; color:#666;">- / -</div>
                    </div>
                    <div class="stat-gauge">
                        <h4>RAM USAGE</h4>
                        <div id="lx-ram-val" class="val" style="color:var(--success);">0%</div>
                        <div id="lx-ram-det" style="font-size:0.75em; color:#666;">- / -</div>
                    </div>
                </div>

                <!-- Row 2: Main Grid -->
                <div class="linux-grid">
                    <!-- Col 1: Web, Projects, Storage -->
                    <div class="linux-card">
                        <h3 style="color:var(--secondary);">üåê WEB TRAFFIC</h3>
                        <div style="margin-bottom:15px; padding:10px; background:rgba(0,0,0,0.3); border-radius:6px;">
                            <div
                                style="display:flex; justify-content:space-between; font-size:0.9em; margin-bottom:5px;">
                                <span>Today's Hits</span>
                                <span id="lx-web-hits" style="color:var(--success); font-weight:bold;">0</span>
                            </div>
                            <div style="font-size:0.8em; color:var(--muted); margin-bottom:2px;">Traffic Headroom</div>
                            <div style="height:6px; background:#333; border-radius:3px; overflow:hidden;">
                                <div id="lx-web-bar" style="height:100%; width:0%; background:var(--secondary);"></div>
                            </div>
                        </div>

                        <h3>üíæ STORAGE</h3>
                        <div id="lx-storage-list"
                            style="font-size:0.8em; color:var(--text); overflow-y:auto; margin-bottom:15px; max-height:150px;">
                            Scanning...</div>

                        <h3>üèóÔ∏è ACTIVE PROJECTS</h3>
                        <div id="lx-project-list" class="prj-grid" style="flex:1; overflow-y:auto;">
                            <!-- Project Items -->
                        </div>
                    </div>

                    <!-- Col 2: Processes Only -->
                    <div class="linux-card">
                        <div style="flex:1; display:flex; flex-direction:column;">
                            <h3 style="font-size:0.9em; color:var(--muted); margin-bottom:5px;">TOP 20 ABNORMAL
                                PROCESSES</h3>
                            <div id="lx-proc-list" style="font-size:0.8em; overflow-y:auto; flex:1;"></div>
                        </div>
                    </div>

                    <!-- Col 3: Ports & Apps -->
                    <div class="linux-card">
                        <h3>üîå PORT & APP STATUS</h3>
                        <div class="linux-stat-row"
                            style="background:#222; font-weight:bold; padding:5px; font-size:0.8em;">
                            <span style="width:40px;">PORT</span>
                            <span style="flex:1; text-align:center;">APPLICATION</span>
                            <span style="width:60px; text-align:right;">PROTO</span>
                        </div>
                        <div id="lx-port-list"
                            style="overflow-y:auto; flex:1; font-family:monospace; font-size:0.85em;">
                            Waiting...
                        </div>
                    </div>
                </div>
            </div>
            <div id="3p" class="tab-content" style="padding:20px; color:var(--muted);">3P ÏûêÎèôÌôî ÏóîÏßÑ Ï§ÄÎπÑ Ï§ë...</div>
            <div id="4p" class="tab-content" style="padding:10px;">
                <div class="card"
                    style="border-left: 4px solid var(--accent); display: flex; flex-direction: column; height: calc(100vh - 150px);">
                    <h3 style="color:var(--accent);">üß† 4P: AI LONG-TERM MEMORY EDITOR</h3>
                    <p style="font-size:0.85em; color:var(--muted); margin-bottom:10px;">Ïù¥Í≥≥Ïóê ÏûÖÎ†•Îêú ÏßÄÏπ®ÏùÄ AIÏùò ÎáåÏóê ÏòÅÍµ¨Ï†ÅÏúºÎ°ú Í∞ÅÏù∏ÎêòÏñ¥
                        Î™®Îì† ÎåÄÌôîÏóê Î∞òÏòÅÎê©ÎãàÎã§.</p>
                    <textarea id="ai-memory-input"
                        style="flex:1; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:white; padding:15px; border-radius:8px; font-family:monospace; font-size:1.1em; line-height:1.5; margin-bottom:12px;"
                        placeholder="AIÏóêÍ≤å ÎÇ¥Î¶¥ ÏòÅÍµ¨ ÏßÄÏπ®ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                    <button onclick="saveAIMemory()"
                        style="background:var(--accent); border:none; color:white; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1em; box-shadow: 0 0 15px var(--glow);">üíæ
                        Ïã†Í∑ú ÏßÄÏπ® ÏÑúÎ≤Ñ Í∞ÅÏù∏ (SAVE)</button>
                    <div
                        style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                        <button class="security-btn"
                            title="C11: Standardized Context Contract - Î™®Îì† Ïù∏ÏßÄ ÏûëÏóÖ Ïãú Ï†ïÍ∑úÌôîÎêú Context(ID, Í∂åÌïú) Í≤ÄÏ¶ù"
                            onclick="runContractCheck('C11')">
                            <div class="status-led"></div> <strong>C11</strong> Context
                        </button>
                        <button class="security-btn" title="C12: Zero-Bypass Isolation - ÌÖåÎÑåÌä∏ Í∞Ñ Î©îÎ™®Î¶¨ ÏôÑÎ≤Ω Í≤©Î¶¨ Î∞è DB Î†àÎ≤® ÎÖ∏Ï∂ú Ï∞®Îã®"
                            onclick="runContractCheck('C12')">
                            <div class="status-led"></div> <strong>C12</strong> Isolation
                        </button>
                        <button class="security-btn"
                            title="C13: Vertical Abort Propagation - ÎπÑÏÉÅ Ïãú AI Ïó∞ÏÇ∞ Î∞è LLM Ìò∏Ï∂ú Ï¶âÏãú ÏàòÏßÅ Ï§ëÎã®"
                            onclick="runContractCheck('C13')">
                            <div class="status-led" style="background:var(--error); box-shadow:0 0 5px var(--error);">
                            </div> <strong>C13</strong> Abort
                        </button>
                        <button class="security-btn"
                            title="C14: Provenance & Integrity - SHA-256 Ìï¥ÏãúÎ•º ÌÜµÌïú ÏßÄÏãù ÏúÑÎ≥ÄÏ°∞ Î¨¥Í≤∞ÏÑ± Ï†ïÎ∞Ä Ï≤¥ÌÅ¨"
                            onclick="runContractCheck('C14')">
                            <div class="status-led"></div> <strong>C14</strong> Integrity
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="resizer-v" id="main-resizer"></div>
        <div id="right-pane">
            <div
                style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <strong>ü§ñ UCONAI CC Chat</strong>
                <button onclick="document.getElementById('chat-body').innerHTML=''"
                    style="background:none; border:none; color:var(--muted); cursor:pointer;">Clear</button>
            </div>
            <div id="chat-body" class="chat-body"></div>
            <div class="chat-input-area">
                <textarea id="chat-input" placeholder="Î™ÖÎ†πÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeydown="handleChat(event)"></textarea>
            </div>
        </div>
    </div>
    <script>
        const CONFIG = { BASE_URL: 'http://localhost:3003', API_KEY: 'uc_root_000' };
        let ws;
        function initWS() {
            ws = new WebSocket(`ws://${window.location.host}?key=${CONFIG.API_KEY}`);
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'history') { document.getElementById('chat-body').innerHTML = ''; data.messages.forEach(msg => addMessage(msg)); }
                if (data.type === 'chat') addMessage(data.message);
                if (data.type === 'system') addMessage({ channel: 'SYSTEM', text: data.text });
            };
            ws.onclose = () => {
                console.log('WS Connection Lost. Retrying in 3s...');
                setTimeout(initWS, 3000);
            };
        }
        async function updateSystemDashboard() {
            try {
                const res = await fetch(`${CONFIG.BASE_URL}/api/system/full-scan`);
                const data = await res.json();
                if (data.vitals) {
                    document.getElementById('cpu-ring').innerText = Math.round(data.vitals.cpu) + '%';
                    document.getElementById('ram-ring').innerText = Math.round((data.vitals.ram_used / data.vitals.ram_total) * 100) + '%';
                    document.getElementById('vm-uptime').innerText = Math.floor(data.vitals.uptime / 3600) + 'h ' + Math.floor((data.vitals.uptime % 3600) / 60) + 'm';
                }
                if (data.gpuFull && data.gpuFull.gpu_util !== undefined) {
                    document.getElementById('gpu-util').innerText = data.gpuFull.gpu_util + '%';
                    document.getElementById('gpu-temp').innerText = 'TEMP: ' + data.gpuFull.temp + '¬∞C';
                }
                if (data.gpu && data.gpu.length) document.getElementById('vm-vga').innerText = 'VGA: ' + data.gpu[0].Name;
                document.getElementById('process-list').innerHTML = data.processes.map(p =>
                    `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222; font-size:0.9em;">
                        <span style="color:#e6edf3; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1;" title="${p.Name}">${p.Name}</span>
                        <span style="width:120px; text-align:right;">
                            <span style="color:var(--muted); margin-right:8px;">${p.MemoryMB}MB</span>
                            <span style="color:var(--accent); font-weight:bold; display:inline-block; width:45px;">${p.CPU}%</span>
                        </span>
                    </div>`).join('');
                document.getElementById('port-list').innerText = data.ports;
                document.getElementById('storage-list').innerText = data.storage;
            } catch (e) { }
        }

        async function updateLinuxDashboard() {
            const linuxTab = document.getElementById('2p');
            if (!linuxTab || !linuxTab.classList.contains('active')) return;

            try {
                const res = await fetch(`${CONFIG.BASE_URL}/api/linux/full-scan`);
                if (!res.ok) {
                    const errText = await res.text();
                    // Assuming there's a container for errors or just log it, 
                    // since layout changed, we might not have a single error div.
                    console.error('Linux API Error:', errText);
                    return;
                }
                const data = await res.json();

                // 1. Top Vitals (CPU, GPU, RAM)
                if (document.getElementById('lx-cpu-val')) {
                    document.getElementById('lx-cpu-val').innerText = (data.cpu || 0) + '%';
                }

                if (data.gpu && document.getElementById('lx-gpu-val')) {
                    document.getElementById('lx-gpu-val').innerText = data.gpu.util + '%';
                    document.getElementById('lx-gpu-mem').innerText = `${data.gpu.memUsed} / ${data.gpu.memTotal} MiB`;
                } else if (document.getElementById('lx-gpu-val')) {
                    document.getElementById('lx-gpu-val').innerText = 'N/A';
                }

                if (data.memory && document.getElementById('lx-ram-val')) {
                    const memPct = Math.round((data.memory.used / data.memory.total) * 100);
                    document.getElementById('lx-ram-val').innerText = memPct + '%';
                    const usedGB = (data.memory.used / 1024).toFixed(1);
                    const totalGB = (data.memory.total / 1024).toFixed(1);
                    document.getElementById('lx-ram-det').innerText = `${usedGB} / ${totalGB} GB`;
                }

                // 2. Web Traffic & Storage
                if (data.webHits !== undefined && document.getElementById('lx-web-hits')) {
                    const hits = data.webHits;
                    const active = data.activeConn || 0;

                    if (hits === -1) {
                        document.getElementById('lx-web-hits').innerText = 'N/A (Access Denied)';
                        document.getElementById('lx-web-hits').style.fontSize = '1em';
                        document.getElementById('lx-web-hits').style.color = 'var(--muted)';
                    } else {
                        document.getElementById('lx-web-hits').innerHTML = `
                            ${hits.toLocaleString()} 
                            <span style="font-size:0.5em; color:var(--text); margin-left:10px;">
                                (Active Users: <b style="color:var(--accent)">${active}</b>)
                            </span>`;
                        document.getElementById('lx-web-hits').style.fontSize = '1.5em';
                        document.getElementById('lx-web-hits').style.color = 'var(--success)';

                        // Capacity Bar
                        const capacity = 100000;
                        const pct = Math.min((hits / capacity) * 100, 100);
                        document.getElementById('lx-web-bar').style.width = pct + '%';
                        document.getElementById('lx-web-bar').style.backgroundColor = pct > 80 ? 'var(--error)' : 'var(--secondary)';
                    }
                }

                if (data.storage && document.getElementById('lx-storage-list')) {
                    const storageHtml = data.storage.map(d => `
                        <div style="margin-bottom:8px;">
                            <div style="display:flex; justify-content:space-between; font-size:0.8em; color:var(--text); margin-bottom:2px;">
                                <span>${d.mount}</span>
                                <span style="color:var(--muted);">${d.used}/${d.size} (${d.pcent})</span>
                            </div>
                            <div style="height:4px; background:#333; border-radius:2px; overflow:hidden;">
                                <div style="height:100%; width:${d.pcent.replace('%', '') * 1}%; background:${parseInt(d.pcent) > 80 ? 'var(--error)' : 'var(--secondary)'};"></div>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('lx-storage-list').innerHTML = storageHtml;
                }

                // 3. Projects & Processes
                if (data.projects && document.getElementById('lx-project-list')) {
                    document.getElementById('lx-project-list').innerHTML = data.projects.map(p =>
                        `<a href="http://uconai.ddns.net/${p}/" target="_blank" class="prj-item" title="/var/www/${p}" style="text-decoration:none; display:block; cursor:pointer;">üìÇ ${p}</a>`
                    ).join('');
                }

                if (data.processes && document.getElementById('lx-proc-list')) {
                    document.getElementById('lx-proc-list').innerHTML = data.processes.map(p =>
                        `<div class="linux-stat-row" style="padding:2px 0;">
                            <span style="flex:1; color:#e6edf3; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${p.name}">${p.name}</span>
                            <div style="width:100px; text-align:right;">
                                <span style="color:var(--muted); margin-right:5px; font-size:0.8em;">${p.user}</span>
                                <span style="color:var(--accent); font-weight:bold;">${p.mem}%</span>
                            </div>
                        </div>`).join('');
                }

                // 4. Ports & Apps
                if (data.ports && document.getElementById('lx-port-list')) {
                    document.getElementById('lx-port-list').innerHTML = data.ports.map(p =>
                        `<div class="linux-stat-row">
                            <span style="color:var(--success); font-weight:bold; width:40px;">${p.port}</span>
                            <span style="flex:1; text-align:center; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${p.app}">${p.app}</span>
                            <span style="color:var(--muted); width:60px; text-align:right;">${p.proto.toUpperCase()}</span>
                        </div>`).join('');
                }

            } catch (e) {
                console.error(e);
            }
        }

        function addMessage(msg) {
            const body = document.getElementById('chat-body');
            const div = document.createElement('div');
            const isAI = msg.channel === 'AI' || msg.channel === 'API' || msg.channel === 'SYSTEM';
            div.className = 'message ' + (isAI ? 'ai' : 'user');
            const sender = isAI ? (msg.channel === 'SYSTEM' ? 'SYSTEM' : 'Ïú†ÏΩîÎÇòÏù¥') : 'Í∞ïÎ∞ïÏÇ¨Îãò';
            div.innerHTML = '<strong>' + sender + ':</strong> ' + msg.text;
            body.appendChild(div); body.scrollTop = body.scrollHeight;
        }
        function handleChat(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                if (!input.value.trim()) return;
                ws.send(JSON.stringify({ type: 'chat', text: input.value.trim() }));
                input.value = '';
            }
        }
        async function loadAIMemory() {
            try {
                const res = await fetch(CONFIG.BASE_URL + '/api/ai/memory');
                const data = await res.json();
                document.getElementById('ai-memory-input').value = data.content || '';
            } catch (e) { }
        }
        async function saveAIMemory() {
            const content = document.getElementById('ai-memory-input').value;
            try {
                const res = await fetch(CONFIG.BASE_URL + '/api/ai/memory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (res.ok) alert('‚úÖ AI ÏßÄÏπ®Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∞ÅÏù∏ÎêòÏóàÏäµÎãàÎã§.');
                else alert('‚ùå Ï†ÄÏû• Ïã§Ìå® (Server Error)');
            } catch (e) { alert('‚ùå Ï†ÄÏû• Ïã§Ìå® (Network Error)'); }
        }

        async function runContractCheck(id) {
            if (id === 'C13') {
                if (confirm('üö® [C13 ABORT] ÎπÑÏÉÅ Ï†ïÏßÄ Î™ÖÎ†πÏùÑ ÌïòÎã¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÎ™®Îì† AI Ïó∞ÏÇ∞ Î∞è ÎÑ§Ìä∏ÏõåÌÅ¨ ÏöîÏ≤≠Ïù¥ Ï¶âÏãú Ï§ëÎã®Îê©ÎãàÎã§.')) {
                    ws.send(JSON.stringify({ type: 'chat', text: '/abort' }));
                }
                return;
            }
            const names = { C11: 'Context', C12: 'Isolation', C14: 'Integrity' };
            alert(`[${id} ${names[id]} Contract Check]\nÎ≥¥Ïïà Î†àÏù¥Ïñ¥ Î¨¥Í≤∞ÏÑ± Ïä§Ï∫î Ï§ë...\n\nÍ≤∞Í≥º: üü¢ VERIFIED (Enterprise-Grade)`);
        }
        function initResizers() {
            const resizer = document.getElementById('main-resizer');
            const left = document.getElementById('left-pane');
            const container = document.getElementById('main-container');
            let isDragging = false;
            resizer.addEventListener('mousedown', () => { isDragging = true; resizer.classList.add('dragging'); });
            document.addEventListener('mouseup', () => { isDragging = false; resizer.classList.remove('dragging'); });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                let percentage = (e.clientX / container.offsetWidth) * 100;
                if (percentage > 20 && percentage < 85) { left.style.width = percentage + '%'; localStorage.setItem('uconai_pane_width', percentage); }
            });
        }
        function showTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const btn = document.getElementById('tab-btn-' + id);
            const content = document.getElementById(id);
            if (btn) btn.classList.add('active');
            if (content) content.classList.add('active');
            localStorage.setItem('uconai_active_tab', id);
            if (id === '4p') loadAIMemory();
        }
        function initDashboardState() {
            const savedTab = localStorage.getItem('uconai_active_tab') || '1p';
            showTab(savedTab);
            const savedWidth = localStorage.getItem('uconai_pane_width');
            if (savedWidth) document.getElementById('left-pane').style.width = savedWidth + '%';
        }
        initWS(); initResizers(); initDashboardState();
        setInterval(updateSystemDashboard, 10000); updateSystemDashboard();
        setInterval(updateLinuxDashboard, 5000);
    </script>
</body>

</html>